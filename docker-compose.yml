# docker-compose.yml
# 多 Agent 股票讨论系统 - 生产部署配置
#
# 使用方法：
#   1. 复制 .env.local.example 为 .env 并填写配置
#   2. docker-compose up -d
#   3. 首次启动后执行数据库迁移：docker-compose exec app npx prisma migrate deploy
#   4. 访问 http://localhost:3000

version: '3.8'

services:
  # Next.js 应用
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      # LLM API
      - OPENAI_API_KEYS=${OPENAI_API_KEYS}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.deepseek.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-deepseek-chat}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-2000}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.7}
      - MODERATOR_API_KEY=${MODERATOR_API_KEY:-}
      # 认证
      - JWT_SECRET=${JWT_SECRET}
      - AUTH_TOKEN_EXPIRES_IN=${AUTH_TOKEN_EXPIRES_IN:-2h}
      - AUTH_REFRESH_TOKEN_EXPIRES_IN=${AUTH_REFRESH_TOKEN_EXPIRES_IN:-7d}
      # 数据库
      - DATABASE_URL=postgresql://multiagent:${POSTGRES_PASSWORD:-multiagent123}@postgres:5432/multiagent?schema=public
      # Redis（可选）
      - REDIS_URL=redis://redis:6379
      # 频率控制
      - RATE_LIMIT_RPM_PER_KEY=${RATE_LIMIT_RPM_PER_KEY:-60}
      - RATE_LIMIT_RPM_PER_USER=${RATE_LIMIT_RPM_PER_USER:-10}
      - MAX_CONCURRENT_LLM_CALLS=${MAX_CONCURRENT_LLM_CALLS:-50}
      # 日志
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      # 持久化用户数据（开发阶段用文件存储时）
      - app-data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3000/api/health').then(r=>{if(!r.ok)throw r.status}).catch(()=>process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL（用户数据、讨论历史、使用量统计）
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=multiagent
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-multiagent123}
      - POSTGRES_DB=multiagent
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U multiagent -d multiagent"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis（会话缓存、频率控制、Key 池状态共享）
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  app-data:
  postgres-data:
  redis-data:
